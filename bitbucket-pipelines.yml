options:
  docker: true
definitions:
  services:
    docker:
      memory: 3072
    docker-large:
      memory: 6144
      type: docker
  steps:
    - step: &build-image
        image: node:16
        name: Build Application
        size: 2x
        deployment: test
        script:
          - ssh-keyscan -H $SSH_SERVER >> ~/.ssh/known_hosts
          - docker build -t nest-setup-api:$BITBUCKET_BUILD_NUMBER -f ./deployment/Dockerfile .
          - docker save -o nest-setup-api.tar nest-setup-api:BITBUCKET_BUILD_NUMBER
          - rsync -avz --progress nest-setup-api.tar -e $SSH_USER@$SSH_SERVER:~
clone:
  depth: full
pipelines:
  branches:
    master:
      - step: *build-image
