options:
  docker: true
definitions:
  services:
    docker:
      memory: 3072
    docker-large:
      memory: 6144
      type: docker
  steps:
    - step: &build-image
        image: node:16
        name: Build Application
        size: 2x
        deployment: test
        script:
          - eval "$(ssh-agent -s)"
          - echo "$SSH_KEY" | tr -d '\r' | ssh-add - > /dev/null
          - mkdir -p ~/.ssh
          - chmod 700 ~/.ssh
          - ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts
          - docker build -t nest-setup-api:$BITBUCKET_BUILD_NUMBER -f ./deployment/Dockerfile . --no-cache
          - docker save -o nest-setup-api.tar nest-setup-api:$BITBUCKET_BUILD_NUMBER
clone:
  depth: full
pipelines:
  branches:
    master:
      - step: *build-image
